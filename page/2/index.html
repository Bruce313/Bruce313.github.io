<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Page 2 | L`Bat的博客</title>

  
  <meta name="author" content="L`Bat">
  

  

  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  

  <meta property="og:site_name" content="L`Bat的博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="L`Bat的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">L`Bat的博客</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/archives">Archives</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    
  <article>

  
    
    <h3 class="article-title"><a href="/2017/02/03/base/js/"><span></span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/02/03/base/js/" rel="bookmark">
        <time class="entry-date published" datetime="2017-02-03T03:03:59.000Z">
          2017-02-03
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>var x = 1;<br>function rain(){<br>      alert(x);   //undefined<br>        var x = ‘3’;<br>          alert(x);   //3<br>}</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2017/02/03/go/pattern/"><span></span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/02/03/go/pattern/" rel="bookmark">
        <time class="entry-date published" datetime="2017-02-03T03:03:59.000Z">
          2017-02-03
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <ul>
<li>不要开启一个goroutine 除非你知道何时终止它</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2017/02/03/db/mysql/"><span></span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/02/03/db/mysql/" rel="bookmark">
        <time class="entry-date published" datetime="2017-02-03T03:03:59.000Z">
          2017-02-03
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <ol>
<li>通过where子句缩小范围，遇到大量计算可以先用简单计算比如&gt; &lt;去判断，然后计算<blockquote>
<p>计算离你最近的10个酒店<br>order by TJJKDJFKDJF(lat, long) limit 10<br><strong>可以</strong> <strong>where lat &gt; a and long &gt; b order by</strong></p>
</blockquote>
</li>
</ol>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2017/02/03/db/postgresql_config_op/"><span></span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/02/03/db/postgresql_config_op/" rel="bookmark">
        <time class="entry-date published" datetime="2017-02-03T03:03:59.000Z">
          2017-02-03
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="postgresql配置优化"><a href="#postgresql配置优化" class="headerlink" title="postgresql配置优化"></a>postgresql配置优化</h1><ul>
<li>关闭<code>auto vacuum</code> 手动（计划）执行</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2017/02/03/db/postgresql_explain/"><span></span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/02/03/db/postgresql_explain/" rel="bookmark">
        <time class="entry-date published" datetime="2017-02-03T03:03:59.000Z">
          2017-02-03
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="postgresql-explain-用法"><a href="#postgresql-explain-用法" class="headerlink" title="postgresql explain 用法"></a>postgresql explain 用法</h1><h2 id="执行计划中代表的意思"><a href="#执行计划中代表的意思" class="headerlink" title="执行计划中代表的意思"></a>执行计划中代表的意思</h2><blockquote>
<p><code>Scan method</code> on <code>table</code>(cost=<code>启动耗时</code>..<code>如果没有limit等 所有的行被读取消耗的时间</code> rows=<code>会影响的行</code> width=<code>所有行的平均宽度(bytes)</code>)<br>   (actual time=<code>准备时间</code>…<code>实际时间</code> rows=<code>实际查询时间</code> loops=<code>这个子查询被执行的次数</code>)</p>
<p>输出是个树行结构 执行也是按照树的依赖来决定顺序和串并行</p>
</blockquote>
<h2 id="影响耗时的因素"><a href="#影响耗时的因素" class="headerlink" title="影响耗时的因素"></a>影响耗时的因素</h2><ol>
<li>执行时间</li>
<li>读取时间</li>
<li>网络消耗</li>
<li>分析语句时间（比如其中涉及的系统调用）</li>
<li>大表和小表得到的执行计划会不同<blockquote>
<p>影响比较大的是scan method &amp; join method</p>
</blockquote>
</li>
</ol>
<h2 id="Scan-method"><a href="#Scan-method" class="headerlink" title="Scan method"></a>Scan method</h2><ol>
<li>seq scan <blockquote>
<p>没有办法或者认为这是最快的方式 比如行比较少</p>
</blockquote>
</li>
<li>index scan<blockquote>
<p>爬树(or hash) 找到位置 <code>立即</code>取数据(random access)</p>
</blockquote>
</li>
<li>index only scan<blockquote>
<p>同index scan但是不用<strong>random access</strong></p>
</blockquote>
</li>
<li>bitmap [heap / index ] scan<blockquote>
<p>同index scan 不过要中间有个bitmap的结构存储index scan的结果 然后读出符合条件的page 再<code>cond recheck</code></p>
</blockquote>
</li>
</ol>
<h2 id="join-method"><a href="#join-method" class="headerlink" title="join method"></a>join method</h2><ol>
<li>nested loop<blockquote>
<p>有条件的一般作为外层表 有索引用index scan</p>
</blockquote>
</li>
<li>hash join<blockquote>
<p>把小表hash. scan大表再去小表中查找 hash一般都耗内存…</p>
</blockquote>
</li>
<li>merge join<blockquote>
<p>把两个表并行排序 然后遍历大表 查找对应的小表</p>
</blockquote>
</li>
</ol>
<h2 id="影响planner的因素"><a href="#影响planner的因素" class="headerlink" title="影响planner的因素"></a>影响planner的因素</h2><ul>
<li>pg_class的一些汇总信息 </li>
</ul>
<h2 id="具体的方法"><a href="#具体的方法" class="headerlink" title="具体的方法"></a>具体的方法</h2><ul>
<li>小表join小表再join大表 而不是让planner自己决定顺序</li>
<li>为了不让analyse不执行 可以包在begin commit中（改重要数据也是一样) </li>
<li>尽量使用index only scan<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">index</span> <span class="keyword">on</span> <span class="keyword">id</span>;</div><div class="line"><span class="keyword">create</span> <span class="keyword">index</span> <span class="keyword">on</span> (a, b)</div><div class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> tab <span class="keyword">where</span> a = <span class="number">1</span></div><div class="line"><span class="comment">-- 并不是index only scan</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol>
<li>优化器选择执行计划是要靠统计信息的 所以在<strong>production</strong>环境分析执行才有意义</li>
</ol>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2017/02/03/db/postgresql_query_op/"><span></span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/02/03/db/postgresql_query_op/" rel="bookmark">
        <time class="entry-date published" datetime="2017-02-03T03:03:59.000Z">
          2017-02-03
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h1 id="pg-查询优化"><a href="#pg-查询优化" class="headerlink" title="pg 查询优化"></a>pg 查询优化</h1><h2 id="Index-Only-Scan"><a href="#Index-Only-Scan" class="headerlink" title="Index Only Scan"></a>Index Only Scan</h2><ul>
<li>pg的索引和数据分离</li>
<li>根据索引查询数据后 未索引的列会<code>random access</code>的读数据区</li>
<li>如果只读带有索引的列 就会快些</li>
<li><code>select x from tab where y = 1</code> create index on (y, x)会触发index only scan</li>
</ul>
<h2 id="确保索引使用"><a href="#确保索引使用" class="headerlink" title="确保索引使用"></a>确保索引使用</h2><ul>
<li>使用真实数据测试</li>
<li>analyze always</li>
<li>强制使用索引 分析消耗</li>
<li>汇总数据可能误导planner pg_class</li>
</ul>
<h2 id="方式"><a href="#方式" class="headerlink" title="方式 "></a>方式 </h2><ul>
<li>用表达式创建索引 <code>create index on tab(func(col))</code></li>
<li>with大法有时会阻止优化器 所以试试子查询</li>
<li>大多数时候<code>select a, b, c</code>要比<code>select *</code>要快</li>
<li>prepared statement</li>
<li>执行<code>cacuum analyze</code>更新统计信息 然后<code>create index</code>会更智能</li>
<li>join要比subquery(select a, (select b from c) as c) 要对优化器友好</li>
<li><code>inner join</code>要比<code>left join</code> 要对优化器友好</li>
<li>避免pattern match把%放在前面<code>like &#39;%abc&#39;</code>, 不会使用索引</li>
<li>使用<code>部分索引(partical index)</code>排除null等</li>
<li>用<code>order by limit</code>代替<code>max min</code> 因为pg对aggr(尤其count)不友好</li>
<li>使用汇总字段 用冗余对读优化</li>
<li>使用冗余 把外表直接写入表 减少join</li>
<li>使用limit影响join, use amap</li>
<li>避免<code>select * from a, b, c where a.id=b.id and a.name = c.name</code> 会产生很多plan 消耗时间</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2017/02/03/db/table_design/"><span></span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2017/02/03/db/table_design/" rel="bookmark">
        <time class="entry-date published" datetime="2017-02-03T03:03:59.000Z">
          2017-02-03
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <ol>
<li>增加汇总字段 各种count</li>
<li>需要外联找到的字段 比如uid或者uname 写入常用这些字段的表 再限制uname的修改</li>
<li>unique来避免 exists(select from tbl)</li>
</ol>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/19/regexp/"><span>regexp</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/19/regexp/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-19T08:27:38.000Z">
          2016-04-19
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <ol>
<li>sds.Trim<blockquote>
<p><code>/abc$/</code>不能匹配”abcdfeabc”因为<code>$</code>代表换行<br><code>/^abc/</code>能, 因为开始总有<em>new line</em></p>
</blockquote>
</li>
</ol>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/19/unit-test/"><span>unit_test</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/19/unit-test/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-19T07:22:38.000Z">
          2016-04-19
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <ol>
<li>test behavior, not the implments</li>
<li>test create-function and assert(like compare eg.) first, to be depended by others</li>
</ol>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>



  <article>

  
    
    <h3 class="article-title"><a href="/2016/04/18/job-log/"><span>job\_log</span></a></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/04/18/job-log/" rel="bookmark">
        <time class="entry-date published" datetime="2016-04-18T07:15:44.000Z">
          2016-04-18
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="2016-04-18"><a href="#2016-04-18" class="headerlink" title="2016/04/18"></a>2016/04/18</h2><ul>
<li>linux<br><em>ENOSPEC</em> no space空间不足(/tmp比如)</li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    

    </div>

    
  </div>
</article>




<nav class="pagination">
  
  <a href="/" class="pagination-prev">Prev</a>
  
  
  <a href="/page/3/" class="pagination-next">Next</a>
  
</nav>
    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2017 L`Bat
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>